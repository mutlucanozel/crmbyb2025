@using System.Globalization

@{
var swalMessage = TempData["SwalMessage"] as string;
var swalIcon = !string.IsNullOrEmpty(swalMessage) && swalMessage.Contains("başarı") ? "success" : "error";
var userNames = ViewBag.UserNames as Dictionary<int, string>;
    }

    @if (!string.IsNullOrEmpty(swalMessage))
    {
    <script>
        Swal.fire({
            icon: '@swalIcon',
            title: '@swalMessage',
            showConfirmButton: false,
            timer: 1500
        });
    </script>
    }

    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Genel Bilgiler</title>

        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Bungee+Tint&family=New+Amsterdam&family=Noto+Sans+Hanunoo&display=swap"
            rel="stylesheet">

        <!-- ZORUNLU: Modal için Popper.js -->
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

        <link rel="stylesheet" type="text/css" href="~/css/definition.css" />
        <script src="https://unpkg.com/html5-qrcode"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        <!-- Modal z-index düzeltmesi -->
        <style>
            .custom-btn {
                background-color: #2C3D4F;
                color: #fff;
                border: none;
                transition: all 0.2s ease-in-out;
                text-align: center;
                width: 100%;
                /* mobilde daha iyi oturur */
            }


            .custom-btn:hover {
                background-color: #3a4e63;
                color: #fff;
                text-decoration: none;
            }


            /* Bootstrap 4 kullanıyorsan gap desteklemiyor olabilir, o zaman: */
            .gap-3>* {
                margin-right: 1rem;
            }

            .gap-3>*:last-child {
                margin-right: 0 !important;
            }


            .modal-backdrop {
                z-index: 1040 !important;
            }

            .modal-content {
                z-index: 1100 !important;
            }

            .container {
                max-width: 100%;
            }

            #qr-reader {
                position: relative;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            #qr-reader>video {
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
                display: block;
                margin: auto;
            }

            #qr-container {
                height: 100%;
            }

            #qr-overlay {
                position: absolute;
                top: 50%;
                left: 50%;
                width: 70%;
                aspect-ratio: 1 / 1;
                transform: translate(-50%, -50%);
                border: 2px dashed rgba(255, 255, 255, 0.7);
                border-radius: 0.5rem;
                pointer-events: none;
                z-index: 10;
            }

            /* + işaretini kaldırmak için */
            #qr-reader__scan_region>div:nth-child(2) {
                display: none !important;
            }

            .modal-body .row>div {
                padding: 6px 0;
                border-bottom: 1px solid #e0e0e0;
                font-size: 15px;
                font-family: "Segoe UI", sans-serif;
            }

            .modal-body .row:last-child>div {
                border-bottom: none;
            }



            .modal-body a {
                color: #007bff;
                text-decoration: underline;
            }

            .modal-body .text-success {
                color: #28a745 !important;
            }

            .modal-body .text-danger {
                color: #dc3545 !important;
            }

            .modal-body .text-primary {
                color: #007bff !important;
            }

            .modal-body .text-warning {
                color: #f0ad4e !important;
            }

            .btn-block-group {
                display: flex;
                flex-wrap: wrap;
                margin-top: 1rem;
            }

            .btn-block-group .btn {
                flex: 1;
                margin-right: 4px;
                white-space: nowrap;
            }

            .btn-block-group .btn:last-child {
                margin-right: 0;
            }

            .modal-body .btn-sm i {
                margin-right: 5px;
            }

            .modal-body .btn {
                font-weight: 600;
            }

            .text-right .btn {
                padding: 6px 16px;
                font-weight: bold;
                font-size: 15px;
            }
        </style>
    </head>

    <body>
        <a id="hiddenPdfDownloadLink" style="display:none;" target="_blank"></a>

        <div class="container">
            <h2 class="display-4 text-center">Bobin Arama</h2>
            <hr />
            <div class="d-flex" style="width: 100%;">
                <input type="text" id="qrInput" class="form-control" placeholder="Bobin Kodu Giriniz"
                    style="width: 50%; background-color: transparent; border-top-right-radius: 0; border-bottom-right-radius: 0; border-top-left-radius: 1rem; border-width: 1px; border-color: #20253B;">

                <button id="getLabelRoll" class="btn"
                    style="width: 50%; background-color: #2C3D4F; border-color: #2C3D4F; color: white; border-top-left-radius: 0; border-top-right-radius: 1rem;">
                    Bobin Ara <i class="fa fa-search"></i>
                </button>
            </div>

            <!-- QR Bobin Detay Modal -->
            <div class="modal fade" id="labelRollModal" tabindex="-1" role="dialog" aria-labelledby="qrModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-xl" role="document">
                    <div class="modal-content" id="labelRollModalContent"
                        style="border-radius: 1.7rem; overflow: hidden;">

                        <div class="modal-header bg-gradient text-white px-4 py-4 position-relative">
                            <div class="w-100 text-center">
                                <h4 class="modal-title fw-bold m-0 text-uppercase" style="letter-spacing: 1px;">

                                    <p class="mt-4"> <i class="fa-solid fa-toilet-paper"
                                            style="margin-right: 0.6rem;"></i> BOBİN BİLGİLERİ</p>
                                </h4>
                            </div>
                            <button type="button" class="close text-white position-absolute"
                                style="right: 1rem; top: 1rem;" data-dismiss="modal" aria-label="Kapat">
                                <span aria-hidden="true" style="font-size: 1.5rem;">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body" id="labelRollModalBody">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Yükleniyor...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="qr-container" class="position-relative w-100 mt-4"
                style="aspect-ratio: 1 / 1; max-width: 100%; border-radius: 1rem; overflow: hidden; box-shadow: 0 0 8px rgba(0,0,0,0.3);">
                <div id="qr-reader"></div>
                <div id="qr-overlay"></div>

                <div id="qr-controls" style="
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                padding: 10px;
                display: flex;
                flex-direction: column;
                gap: 8px;">
                    <!-- Buton ve input yukarıda -->
                </div>
            </div>

            <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
            <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
            <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.5.4/dist/autoNumeric.min.js"></script>

            <script>
                $(document).ready(function () {
                    // Enter tuşu ile arama tetikleme
                    $('#qrInput').on('keypress', function (e) {
                        if (e.which === 13) { // 13 = Enter
                            e.preventDefault(); // Form submit olmasın
                            $('#getLabelRoll').click();
                        }
                    });
                });
                $(document).ready(function () {
                    const html5QrCode = new Html5Qrcode("qr-reader");

                    Html5Qrcode.getCameras().then(cameras => {
                        if (cameras && cameras.length) {
                            html5QrCode.start(
                                { facingMode: "environment" },
                                {
                                    fps: 10,
                                    disableFlip: true,
                                    qrbox: function (viewfinderWidth, viewfinderHeight) {
                                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                                        return {
                                            width: minEdge * 0.7,
                                            height: minEdge * 0.7
                                        };
                                    }
                                },
                                onScanSuccess,
                                onScanFailure
                            );
                        }
                    }).catch(err => {
                        Toastify({
                            text: "Kamera erişimine izin verdikten sonra tekrar deneyin.",
                            duration: 7000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "#2C3D4F", // kırmızı
                            stopOnFocus: true,
                            close: false
                        }).showToast();
                    });

                    // Kaydet butonuna tıklanınca örnek Toastify gösterimi
                    $(document).on('click', '#btnKesimKaydet', function () {
                        let values = [];
                        for (let i = 1; i <= 6; i++) {
                            values.push(parseFloat($(`#kesim${i}`).val()) || 0);
                        }

                        console.log("Kesim Genişlikleri:", values);

                        Toastify({
                            text: "✅ Kesim bilgileri alındı!",
                            duration: 3000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "#28a745"
                        }).showToast();

                        // İsteğe bağlı: AJAX gönderimi buraya entegre edilebilir
                    });

                    $('#getLabelRoll').on('click', function () {
                        const qr = $('#qrInput').val().trim();
                        if (!qr) return;

                        $('#labelRollModalBody').html('<div class="text-center p-4"><div class="spinner-border"></div></div>');
                        $('#labelRollModal').modal('show');

                        $.get('/Erp/GetLabelRoll', { qrCode: qr }, function (res) {
                            if (!res.success) {
                                $('#labelRollModalBody').html(`<div class="alert alert-danger">${res.message}</div>`);
                                return;
                            }
                            const d = res.data;
                            const html = `
<div class="container-fluid mt-2" style="font-family: 'Segoe UI', sans-serif; font-size: 15px;">
  <div class="row">
    <div class="col-md-6 pr-md-3">
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Güncel Durum:</div>
        <div class="col-6 text-success text-right text-break">${d.guncelDurum}</div>
      </div>
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold d-flex align-items-center">Bobin Kodu:</div>
        <div class="col-6 d-flex justify-content-end align-items-center" style="gap: 10px; flex-wrap: nowrap;">
          <span class="text-danger font-weight-bold" style="white-space: nowrap;">${d.labelRollCode}</span>
          <button class="btn btn-warning btn-sm" onclick="window.open('/Erp/DownloadLabelRollAsPdf?id=${d.labelRollId}', '_blank')">
            PDF <i class="fas fa-download ml-2"></i>
          </button>
        </div>
      </div>
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Stok Kart:</div>
        <div class="col-6 text-primary text-right text-break">${d.stockCardName}</div>
      </div>
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Güncel Genişlik:</div>
     <div class="col-6 text-right">
  ${Number(d.width).toLocaleString("de-DE", { minimumFractionDigits: 0 })} cm
</div>

      </div>
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Güncel Uzunluk:</div>
        <div class="col-6 text-right">${Number(d.length).toLocaleString("de-DE", { minimumFractionDigits: 0 })} m</div>
      </div>
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Detay:</div>
        <div class="col-6 text-right text-break">${d.paperInfo || '-'}</div>
      </div>
    </div>

    <div class="col-md-6 pl-md-3">
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Tedarik Tarihi:</div>
        <div class="col-6 text-right">${d.tedarikTarihi}</div>
      </div>
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Tedarikçi:</div>
        <div class="col-6 text-right text-break">${d.tedarikci}</div>
      </div>
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Güncel Depo:</div>
        <div class="col-6 text-primary text-right">${d.depo ?? ''}</div>
      </div>
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Güncel Adres:</div>
        <div class="col-6 text-primary text-right text-break">${d.adres}</div>
      </div>
      <div class="d-flex flex-wrap border-bottom py-2">
        <div class="col-6 font-weight-bold">Kullanılabilirlik Durumu:</div>
        <div class="col-6 text-right">
          ${d.kullanilabilirlikDurumu === "Kullanılabilir"
                                    ? '<span class="text-success font-weight-bold">Kullanılabilir </span>'
                                    : '<span class="text-danger font-weight-bold">Kullanılamaz </span>'}
        </div>
      </div>
      <div class="d-flex flex-wrap border-bottom py-2 align-items-center">
        <div class="col-6 font-weight-bold d-flex align-items-center">Bobin Hareketleri:</div>
        <div class="col-6 d-flex">
          <button class="btn custom-btn btn-sm">Hareketleri İncele <i class="fas fa-history ml-2"></i></button>
        </div>
      </div>
    </div>
  </div>


  <div class="row mt-4">
    <div class="col-12 d-flex flex-wrap justify-content-center gap-3">
      <button class="btn custom-btn btn-adresleme m-2 py-3 px-3 rounded-2 d-flex align-items-center justify-content-center"
        style="min-width: 160px; flex: 1 1 220px;">
        <i class="fas fa-warehouse mr-2"></i> Adresleme Değiştir
      </button>
      <button class="btn custom-btn m-2 py-3 px-3 rounded-2 d-flex align-items-center justify-content-center"
        style="min-width: 160px; flex: 1 1 220px;">
        <i class="fas fa-lightbulb mr-2"></i> Üretime Sarf Et
      </button>
    <button id="btnBobinKes" class="btn custom-btn m-2 py-3 px-3 rounded-2 d-flex align-items-center justify-content-center"
    style="min-width: 160px; flex: 1 1 220px;">
    <i class="fas fa-cut mr-2"></i> Bobini Kes
</button>
      <button class="btn custom-btn m-2 py-3 px-3 rounded-2 d-flex align-items-center justify-content-center"
        style="min-width: 160px; flex: 1 1 220px;">
        <i class="fas fa-times mr-2"></i> İptal Et
      </button>
    </div>
  </div>




<div id="kesimFormu" style="display: none;" class="mt-4 p-3 border rounded bg-light">
    <h4 class="text-center text-success mb-3">Bobini Kes</h4>

    <div class="form-row">
        @for (int i = 1; i <= 6; i++)
        {
            <div class="form-group col-md-4">
                <label for="kesim@i">@i. Kesim Genişliği</label>
                <input type="number" class="form-control" id="kesim@i" value="0" min="0" />
            </div>
        }
    </div>

    <button class="btn btn-success btn-block font-weight-bold mt-3" id="btnKesimKaydet">
        <i class="fas fa-cut mr-2"></i> KES
    </button>
</div>
      
  <div id="addressChangeSection" style="display: none;" class="mt-4 p-3 border rounded bg-light">
    <h4 class="text-center text-warning mb-3">Adres Değiştir</h4>
   <div class="form-row">
  <div class="form-group col-md-4">
    <label for="depoSelect">Depo</label>
    <select class="form-control" id="depoSelect"></select>
  </div>

<div class="form-group col-md-4">
    <label for="siraSelect">Sıra</label>
    <select class="form-control" id="siraSelect"></select>
</div>
<div class="form-group col-md-4">
    <label for="noSelect">No</label>
    <select class="form-control" id="noSelect"></select>
</div>



    <button class="btn btn-warning btn-block font-weight-bold mt-2" id="btnAdresKaydet">
      <i class="fas fa-save mr-2"></i> KAYDET
    </button>
  </div>
</div>
`;

                            $('#labelRollModalBody').html(html);
                        }).fail(() => {
                            $('#labelRollModalBody').html('<div class="alert alert-danger">Veri alınamadı</div>');
                        });
                    });
                    let allWarehouses = [];

                    function fillDepoSelect() {
                        $.get('/erp/GetWareHouses', function (data) {
                            allWarehouses = data;
                            console.log("Depolar JSON:", data);

                            const depoSelect = $('#depoSelect');
                            depoSelect.empty();

                            data.forEach(w => {
                                depoSelect.append(`<option value="${w.id}">${w.name}</option>`);
                            });

                            if (data.length > 0) {
                                depoSelect.val(data[0].id).trigger('change');
                            }
                        });
                    }
                    // SIRA ve NO doldur
                    $(document).on('change', '#depoSelect', function () {
                        const selectedId = parseInt($(this).val());
                        const selectedWarehouse = allWarehouses.find(w => w.id === selectedId);

                        if (selectedWarehouse) {
                            const noSelect = $('#noSelect');
                            const siraSelect = $('#siraSelect');

                            noSelect.empty();
                            siraSelect.empty();

                            const noValue = parseInt(selectedWarehouse.no);
                            const rowValue = selectedWarehouse.row.trim().toUpperCase();

                            // No'yu 0'dan no değerine kadar doldur
                            if (!isNaN(noValue)) {
                                for (let i = 0; i <= noValue; i++) {
                                    noSelect.append(`<option value="${i}">${i}</option>`);
                                }
                            }

                            // Sıra harf mi sayı mı kontrol et
                            if (isNaN(rowValue)) {
                                const endCharCode = rowValue.charCodeAt(0);
                                for (let i = 65; i <= endCharCode; i++) {
                                    const char = String.fromCharCode(i);   // Görünen harf
                                    const num = i - 64; // A=1, B=2, ..., Z=26
                                    siraSelect.append(`<option value="${num}">${char}</option>`);
                                }


                            } else {
                                const endNumber = parseInt(rowValue);
                                for (let i = 0; i <= endNumber; i++) {
                                    siraSelect.append(`<option value="${i}">${i}</option>`);
                                }
                            }
                        }
                    });
                    $(document).on('click', '#btnAdresKaydet', function () {
                        const qrCode = $('#qrInput').val().trim();
                        const depoId = $('#depoSelect').val();
                        const no = $('#noSelect').val();
                        const sira = $('#siraSelect').val();

                        if (!qrCode || !depoId || !no || !sira) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Eksik bilgi',
                                text: 'Lütfen tüm alanları doldurun.'
                            });
                            return;
                        }

                        $.ajax({
                            type: 'POST',
                            url: '/Erp/UpdateLabelRollAddress',
                            data: {
                                qrCode: qrCode,
                                depoId: depoId,
                                no: no,
                                sira: sira
                            },
                            success: function (res) {
                                if (res.success) {
                                    Toastify({
                                        text: "Adres bilgisi güncellendi",
                                        duration: 2500,
                                        gravity: "right",
                                        position: "right",
                                        backgroundColor: "#2C3D4F"
                                    }).showToast();
                                    $('#addressChangeSection').slideUp();
                                    $('#getLabelRoll').click(); // güncellenmiş veriyi tekrar çek
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Hata',
                                        text: res.message || 'Adres güncellenirken hata oluştu.'
                                    });
                                }
                            },
                            error: function () {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Sunucu hatası',
                                    text: 'İşlem gerçekleştirilemedi.'
                                });
                            }
                        });
                    });

                    // Adresleme butonuna tıklanınca modal açılırsa select'i o an doldur!
                    $(document).on('click', '.btn-adresleme', function () {
                        $('#kesimFormu').slideUp(); // Kesim formunu kapat
                        $('#addressChangeSection').slideToggle(); // Adres formunu aç/kapat

                        if ($('#addressChangeSection').is(':visible')) {
                            fillDepoSelect(); // sadece açıldığında doldur
                        }
                    });


                    // Bobini Kes butonuna tıklanınca kesim formu açılır, adres formu kapanır
                    $(document).on('click', '#btnBobinKes', function () {
                        $('#addressChangeSection').slideUp(); // Adres formunu kapat
                        $('#kesimFormu').slideToggle(); // Kesim formunu aç/kapat
                    });
                    let scanCooldown = false;
                    const beepSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

                    $(document).one('click touchstart', function () {
                        beepSound.load();
                    });

                    function onScanSuccess(decodedText) {
                        if (scanCooldown) return;

                        scanCooldown = true;

                        $('#qrInput').val(decodedText);
                        $('#getLabelRoll').click();

                        beepSound.currentTime = 0;
                        beepSound.play().catch(() => { });

                        Toastify({
                            text: decodedText,
                            duration: 2500,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "#2C3D4E",
                            stopOnFocus: true
                        }).showToast();

                        setTimeout(() => {
                            scanCooldown = false;
                        }, 3500);
                    }

                    function onScanFailure(error) {
                        // opsiyonel
                    }
                });
            </script>
        </div>
    </body>

    </html>