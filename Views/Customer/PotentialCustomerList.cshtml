<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MÃ¼ÅŸteri Listesi</title>
    <link rel="stylesheet" type="text/css" href="~/css/listcustomer.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

</head>

@using System.Security.Claims
@{
var firstName = System.Net.WebUtility.HtmlDecode(User.FindFirst("FirstName")?.Value ?? string.Empty);
var lastName = System.Net.WebUtility.HtmlDecode(User.FindFirst("LastName")?.Value ?? string.Empty);
bool isYetkili = User.IsInRole("YÃ¶netici") || User.IsInRole("Denetlemeci");


ViewBag.UserName = $"{firstName} {lastName}";
}


    <div class="container">
        <h4 class="display-4 text-center">Potansiyel â“ MÃ¼ÅŸteri Listesi</h4>
        <hr>
        <div class="d-flex justify-content-between align-items-center mb-3" style="gap: 10px;">
            <input type="text" class="form-control search-input-custom" id="searchInput"
                placeholder="Herhangi bir parametre ile ara..." style="margin: 0; flex-grow: 1; height: 60px;">

        </div>
        <hr>
        <div class="button-container">
            <div class="button-group">
                @if (isYetkili)
                {
                <button class="btn btn-outline-dark mb-3 btn-lg" data-toggle="modal" data-target="#addCustomerModal">
                    Potansiyel MÃ¼ÅŸteri Ekle <i class="fa-solid fa-user-plus"></i>
                </button>

                <button class="btn btn-outline-dark mb-3 btn-lg"
                    onclick="exportTableToExcel('user-table', 'MusteriListesi.xlsx')">
                    Tabloyu Excel'e Aktar <i class="fa-solid fa-download"></i>
                </button>
                }

            </div>
            <!-- <button class="btn btn-outline-dark mb-3 btn-lg" id="deleteSelected">
            SeÃ§ilen MÃ¼ÅŸterileri Sil <i class="fa fa-trash"></i>
        </button> -->
        </div>
        <div class="table-header" style="text-align: center;">
            <h5 id="customerCount"
                style="font-size: 1.2em; font-weight: bold; color: #4F75FF; border: 2px solid #4379F2; display: inline-block; padding: 10px 20px; border-radius: 8px; background-color: #f0f8ff;">
                Listelenen Potansiyel MÃ¼ÅŸterilerinizin SayÄ±sÄ±: 0
            </h5>
        </div>
        <div class="table-responsive">
            <table id="user-table" class="user-table table table-bordered">

                <thead>
                    <tr>
                        <!-- <th><input type="checkbox" id="selectAll"></th> -->
                        <th>Id</th>
                        <th>Ad</th>
                        <th>Ä°l</th>
                        <th>Ä°lÃ§e</th>
                        <th>Randevu Tarihi</th>
                        <th>MÃ¼ÅŸteri Sorumlusu</th>
                        <th>Durum </th>
                        <th>Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null)
                    {
                    foreach (var customer in Model)
                    {
                    <tr>
                        <!-- <td><input type="checkbox" class="selectCustomer" data-id="@customer.Id"></td> -->
                        <td>@customer.Id</td>
                        <td>@customer.Name</td>
                        <td>@customer.City</td>
                        <td>@customer.District</td>
                        <td>@(customer.LastVisitActualDate?.ToString("dd.MM.yyyy") ?? "HenÃ¼z ziyaret planlanmadÄ±")</td>
                        <td>@customer.CreatedBy</td>


                        <td>
                            @{
                                // Records listesini statik bir tipe dÃ¶nÃ¼ÅŸtÃ¼r
                                var records = customer.Records as List<RecordViewModel>;
                            
                                // "Ziyaret" durumuna sahip kayÄ±tlarÄ± filtrele
                                bool anyZiyaretRecordHasActualDate = records != null && records.Any(record => 
                                    record.Status == "Ziyaret" && record.ActualDate != null);
                            
                                // Son kayÄ±t (herhangi bir kayÄ±t) Id'ye gÃ¶re belirle
                                var lastRecord = records?.OrderByDescending(r => r.Id).FirstOrDefault();
                            
                                // Son "Ziyaret" kaydÄ±nÄ± Id'ye gÃ¶re belirle
                                var lastZiyaretRecord = records?.Where(r => r.Status == "Ziyaret")
                                                                .OrderByDescending(r => r.Id)
                                                                .FirstOrDefault();
                            
                                string buttonClass = "btn btn-lg "; // VarsayÄ±lan buton sÄ±nÄ±fÄ±
                                string buttonText = ""; // GÃ¶sterilecek metin
                            
                                if (anyZiyaretRecordHasActualDate)
                                {
                                    buttonClass += "btn-success"; // YeÅŸil buton
                                    buttonText = "GerÃ§ekleÅŸti âœ…";
                                }
                                else if (records == null || !records.Any())
                                {
                                    buttonClass += "btn-warning text-dark"; // SarÄ± buton
                                    buttonText = "Eklendi âš ï¸";
                                }
                                else if (customer.IsOwned)
                                {
                                    buttonClass += "btn-primary"; // Mavi buton
                                    buttonText = "Sahiplenildi ğŸ†—";
                                }
                                else if (lastZiyaretRecord != null)
                                {
                                    if (lastZiyaretRecord.Status == "Ziyaret")
                                    {
                                        buttonClass += "btn-info text-white"; // AÃ§Ä±k mavi buton
                                        buttonText = "Randevu oluÅŸturuldu ğŸ—“ï¸";
                                    }
                                    else
                                    {
                                        buttonClass += "btn-secondary"; // Gri buton
                                        buttonText = $"{lastZiyaretRecord.Status} kaydÄ± eklendi.";
                                    }
                                }
                                else if (lastRecord != null)
                                {
                                    buttonClass += "btn-info"; // KÄ±rmÄ±zÄ± buton
                                    buttonText = $"{lastRecord.Status} kaydÄ± eklendi.";
                                }
                                else
                                {
                                    buttonClass += "btn-info"; // KÄ±rmÄ±zÄ± buton
                                    buttonText = "HiÃ§bir kayÄ±t yok.";
                                }
                            }
                            
                            <button class="@buttonClass">
                                @buttonText
                            </button>
                            
                        </td>






                        <!-- Table Cell -->
                        <td style="text-align: center; vertical-align: middle;">
                            <!-- Button Element -->
                            <a class="btn btn-dark" href="@Url.Action("PotentialCustomerDetail","Customer" , new {
                                id=customer.Id })"
                                style="display: inline-flex; justify-content: center; align-items: center; width: 60px; height: 60px;">
                                <i class='fas fa-sign-in-alt' style="font-size: 24px; margin: 0;"></i>
                            </a>
                        </td>

                    </tr>
                    }
                    }
                    else
                    {
                    <tr>
                        <td colspan="8">Veri yÃ¼klenemedi</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        <hr>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" role="dialog" aria-labelledby="addCustomerModalLabel"
        aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="addCustomerModalLabel">MÃ¼ÅŸteri Ekle</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addPotentialCustomerForm" class="needs-validation" novalidate>
                        @Html.AntiForgeryToken()

                        <div class="form-group">
                            <label for="name">Firma AdÄ±</label>
                            <input type="text" class="form-control" id="name" name="Name" required>
                            <div class="invalid-feedback">LÃ¼tfen firma adÄ±nÄ± girin.</div>
                        </div>


                        <div class="form-group">
                            <label for="images">Resimler</label>
                            <input type="file" class="form-control" id="images" name="UploadedImages" accept="image/*"
                                capture="camera" multiple>

                        </div>


                        <div class="form-group">
                            <label for="CreatedBy">MÃ¼ÅŸteri Sorumlusu</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="CreatedBy" name="CreatedBy" readonly
                                    value="@Html.Raw(ViewBag.UserName)">
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fa fa-handshake"
                                            aria-hidden="true"></i></span>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="IsPotential" value="true">

                        <button type="submit" class="btn btn-outline-dark mb-3 btn-lg">
                            Potansiyel MÃ¼ÅŸteri Ekle <i class="fa fa-check" aria-hidden="true"></i>
                        </button>
                    </form>

                </div>
            </div>
        </div>
    </div>





    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const table = document.getElementById("user-table");
            const headers = table.querySelectorAll("thead th");
            const tbody = table.querySelector("tbody");
            let currentSortColumn = null;
            let currentSortOrder = "asc";

            headers.forEach((header, index) => {
                header.addEventListener("click", function () {
                    // Ã–nce tÃ¼m sÃ¼tunlardan aktif sÄ±nÄ±fÄ± ve ikonlarÄ± kaldÄ±r.
                    headers.forEach(h => {
                        h.classList.remove("active");
                        const icon = h.querySelector(".sort-icon");
                        if (icon) icon.remove();
                    });

                    // Åimdiki sÃ¼tuna aktif sÄ±nÄ±fÄ± ekle.
                    header.classList.add("active");

                    // SÄ±ralama yÃ¶nÃ¼nÃ¼ deÄŸiÅŸtir veya varsayÄ±lan olarak "asc" yap.
                    if (currentSortColumn === index) {
                        currentSortOrder = currentSortOrder === "asc" ? "desc" : "asc";
                    } else {
                        currentSortColumn = index;
                        currentSortOrder = "asc";
                    }

                    // SÄ±ralama ikonunu ekle.
                    const sortIcon = document.createElement("span");
                    sortIcon.classList.add("sort-icon");
                    sortIcon.innerHTML = currentSortOrder === "asc" ? "â–²" : "â–¼";
                    header.appendChild(sortIcon);

                    // SatÄ±rlarÄ± sÄ±ralama.
                    const isDateColumn = header.innerText.includes("Randevu Tarihi");
                    const rows = Array.from(tbody.querySelectorAll("tr"));

                    rows.sort((rowA, rowB) => {
                        const cellA = rowA.children[index].innerText.trim();
                        const cellB = rowB.children[index].innerText.trim();

                        if (isDateColumn) {
                            const dateA = new Date(cellA.split('.').reverse().join('-'));
                            const dateB = new Date(cellB.split('.').reverse().join('-'));
                            return currentSortOrder === "asc" ? dateA - dateB : dateB - dateA;
                        } else {
                            return currentSortOrder === "asc"
                                ? cellA.localeCompare(cellB, 'tr')
                                : cellB.localeCompare(cellA, 'tr');
                        }
                    });

                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        });
        $('#addPotentialCustomerForm').on('submit', function (e) {
            e.preventDefault();
            var formData = new FormData(this);

            $.ajax({
                url: '/Customer/AddPotentialCustomer',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,

                success: function (response) {
                    if (response.success) {
                        Toastify({
                            text: "Potansiyel mÃ¼ÅŸteri baÅŸarÄ±yla eklendi",
                            duration: 5000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "green", // BaÅŸarÄ± yeÅŸil rengi
                            close: false
                        }).showToast(); setTimeout(function () {
                            location.reload();
                        }, 2000);

                        // Formu sÄ±fÄ±rla
                        $('#addPotentialCustomerForm')[0].reset();
                    } else if (response.message.includes('Bu isimle baÅŸlayan mevcut firmalar')) {
                        // Benzer isimli mÃ¼ÅŸteriler var ise Swal ile onay penceresi gÃ¶ster
                        Swal.fire({
                            title: 'Benzer Ä°simli MÃ¼ÅŸteri Mevcut!',
                            text: response.message,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Evet, Ekle',
                            cancelButtonText: 'HayÄ±r, Ä°ptal Et'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                formData.append('ForceAdd', true); // ForceAdd parametresini ekle
                                $.ajax({
                                    url: '/Customer/AddPotentialCustomer',
                                    type: 'POST',
                                    data: formData,
                                    processData: false,
                                    contentType: false,
                                    success: function (response) {
                                        if (response.success) {
                                            Toastify({
                                                text: "Potansiyel mÃ¼ÅŸteri baÅŸarÄ±yla eklendi",
                                                duration: 5000,
                                                gravity: "top",
                                                position: "right",
                                                backgroundColor: "green",
                                                close: false
                                            }).showToast(); setTimeout(function () {
                                                location.reload();
                                            }, 2000);

                                            // Formu sÄ±fÄ±rla
                                            $('#addPotentialCustomerForm')[0].reset();
                                        } else {
                                            Toastify({
                                                text: response.message,
                                                duration: 5000,
                                                gravity: "top",
                                                position: "right",
                                                backgroundColor: "red", // Hata kÄ±rmÄ±zÄ± rengi
                                                close: false
                                            }).showToast();
                                        }
                                    },
                                    error: function (err) {
                                        Toastify({
                                            text: 'Hata oluÅŸtu: ' + (err.responseJSON?.message || 'Yetkiniz olduÄŸundan emin olun ! '),
                                            duration: 5000,
                                            gravity: "top",
                                            position: "right",
                                            backgroundColor: "red",
                                            close: false
                                        }).showToast();
                                    }
                                });
                            }
                        });
                    } else {
                        Toastify({
                            text: response.message,
                            duration: 5000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "red", // Hata kÄ±rmÄ±zÄ± rengi
                            close: false
                        }).showToast();
                    }
                },
                error: function (err) {
                    Toastify({
                        text: '' + (err.responseJSON?.message || 'Bu iÅŸlem iÃ§in yetkinizin olduÄŸundan emin olun !'),
                        duration: 5000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "red", // Hata kÄ±rmÄ±zÄ± rengi
                        close: false
                    }).showToast();
                }
            });
        });

        async function exportTableToExcel(tableID, filename = 'MusteriListesi.xlsx') {
            const table = document.getElementById(tableID);

            // Yeni bir workbook oluÅŸtur
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Sheet1");

            // Controller'dan gelen Contacts bilgilerini alÄ±n
            const contactsData = JSON.parse('@Html.Raw(ViewBag.ContactsJson)');

            // Tablo baÅŸlÄ±klarÄ±nÄ± al ve "Ä°ÅŸlemler" baÅŸlÄ±ÄŸÄ±nÄ± hariÃ§ tut
            const headerRow = table.querySelector("thead tr");
            const headers = Array.from(headerRow.querySelectorAll("th"))
                .map(cell => cell.textContent.trim())
                .filter(header => header !== "Ä°ÅŸlemler"); // "Ä°ÅŸlemler" sÃ¼tununu hariÃ§ tut

            // Ek baÅŸlÄ±klar ekle (Contacts bilgileri iÃ§in)
            headers.push("Id", "GÃ¶revi", "Ä°sim Soyisim", "Telefon", "Cinsiyet", "Email");

            const excelHeaderRow = worksheet.addRow(headers);
            excelHeaderRow.eachCell(cell => {
                cell.font = { bold: true }; // BaÅŸlÄ±klarÄ± kalÄ±n yap
                cell.alignment = { horizontal: "center", vertical: "middle" }; // Ortala
            });

            // YalnÄ±zca gÃ¶rÃ¼nÃ¼r satÄ±rlarÄ± alÄ±n
            const rows = Array.from(table.querySelectorAll("tbody tr")).filter(row => {
                return row.style.display !== "none"; // GÃ¶rÃ¼nÃ¼r satÄ±rlarÄ± filtrele
            });

            // Tablodaki gÃ¶rÃ¼nÃ¼r satÄ±r verilerini ekle
            rows.forEach(row => {
                const rowData = Array.from(row.querySelectorAll("td"))
                    .map(cell => cell.textContent.trim());

                // "Ä°ÅŸlemler" sÃ¼tununun indeksini belirle ve o sÃ¼tunu hariÃ§ tut
                const operationColumnIndex = Array.from(headerRow.querySelectorAll("th"))
                    .findIndex(cell => cell.textContent.trim() === "Ä°ÅŸlemler");

                if (operationColumnIndex !== -1) {
                    rowData.splice(operationColumnIndex, 1); // "Ä°ÅŸlemler" sÃ¼tununu Ã§Ä±kar
                }

                // MÃ¼ÅŸteri Id'sine gÃ¶re Contacts bilgilerini ekle
                const customerId = row.querySelector("td:first-child").textContent.trim();
                const customerContacts = contactsData[customerId] || [];

                // Contacts verilerini ayÄ±kla ve ekle
                rowData.push(
                    customerContacts.map(contact => contact.Id).join(", ") || "",
                    customerContacts.map(contact => contact.Title).join(", ") || "",
                    customerContacts.map(contact => contact.FullName).join(", ") || "",
                    customerContacts.map(contact => contact.PhoneNumber).join(", ") || "",
                    customerContacts.map(contact => contact.Gender).join(", ") || "",
                    customerContacts.map(contact => contact.Email).join(", ") || ""
                );

                // SatÄ±rlarÄ± Excel'e ekle
                const excelRow = worksheet.addRow(rowData);

                // HÃ¼creleri ortala
                excelRow.eachCell(cell => {
                    cell.alignment = { horizontal: "center", vertical: "middle" }; // Ortala
                });
            });

            // Kolon geniÅŸliklerini ayarla
            worksheet.columns = headers.map(() => ({ width: 20 }));

            // Excel dosyasÄ±nÄ± indir
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        document.getElementById('searchInput').addEventListener('keyup', function () {
            // KullanÄ±cÄ±nÄ±n girdiÄŸi arama deÄŸerini al ve TÃ¼rkÃ§e karakterlere duyarlÄ± olarak kÃ¼Ã§Ã¼lt
            var searchValue = this.value.toLocaleLowerCase('tr-TR').trim();

            // Arama deÄŸerini boÅŸluklara gÃ¶re bÃ¶l ve kelimeleri al
            var searchTerms = searchValue.split(' ').filter(function (term) {
                return term.trim() !== ''; // BoÅŸ olmayan terimleri al
            });

            // Arama iÅŸlemini baÅŸlat
            filterTable(searchTerms);
        });

        function filterTable(searchTerms) {
            // Tablo satÄ±rlarÄ±nÄ± seÃ§
            var tableRows = document.querySelectorAll('.user-table tbody tr');

            // Her bir satÄ±rÄ± kontrol et
            tableRows.forEach(function (row) {
                // SatÄ±rÄ±n text iÃ§eriÄŸini TÃ¼rkÃ§e karakterlere duyarlÄ± olarak kÃ¼Ã§Ã¼lt
                var rowText = row.textContent.toLocaleLowerCase('tr-TR').trim();

                // Her bir arama teriminin satÄ±r metninde olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                var matchesSearch = searchTerms.every(function (term) {
                    return rowText.includes(term);
                });

                // Arama kriterlerine uyan satÄ±rlarÄ± gÃ¶ster, uymayanlarÄ± gizle
                if (matchesSearch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            updateCustomerCount();
        }
        function updateCustomerCount() {
            const visibleRows = document.querySelectorAll(".user-table tbody tr:not([style*='display: none'])");
            const totalCustomers = visibleRows.length;
            document.getElementById("customerCount").innerText = "Listelenen Potansiyel MÃ¼ÅŸterilerin SayÄ±sÄ±: " + totalCustomers;
        }
        // Sayfa yÃ¼klendiÄŸinde mÃ¼ÅŸteri sayÄ±sÄ±nÄ± ilk olarak gÃ¼ncelle
        document.addEventListener("DOMContentLoaded", function () {
            updateCustomerCount();
        });

        $(document).ready(function () {


            $(document).ready(function () {
                // Tablo satÄ±rlarÄ±nÄ± al
                var rows = $('.user-table tbody tr');

                // SatÄ±rlarÄ± sÄ±ralamak iÃ§in bir dizi oluÅŸtur
                rows.sort(function (a, b) {
                    var idA = parseInt($(a).find('td').eq(0).text()); // Ä°lk hÃ¼credeki ID
                    var idB = parseInt($(b).find('td').eq(0).text()); // Ä°lk hÃ¼credeki ID
                    return idB - idA; // BÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe sÄ±ralama
                });

                // SÄ±ralanmÄ±ÅŸ satÄ±rlarÄ± tekrar tabloya ekle
                $('.user-table tbody').empty().append(rows);
            });





        });
    </script>