@using System.Globalization

@{
    var createdByEmail = ViewData["CreatedByEmail"] as string; // ViewData iÃ§indeki e-posta bilgisini deÄŸiÅŸkene al
    bool isAdmin = User.IsInRole("YÃ¶netici"); // YÃ¶netici kontrolÃ¼
    bool isGenelMÃ¼dÃ¼r = User.IsInRole("GENEL MÃœDÃœR");
    bool hasPermission = isAdmin || isGenelMÃ¼dÃ¼r; // YÃ¶netici veya Genel MÃ¼dÃ¼r
}



<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teklif DetaylarÄ±</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="~/css/detailsoffer.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="container pdf-container">
        <div class="row">
            <div class="col-md-6">
                <div class="pdf-header">
                    <h2>TEKLÄ°F DETAYLARI </h2>
                    
                </div><div class="pdf-section">

                    <form id="updatePriceForm" class="mt-3">
                        <input type="hidden" id="offerId" name="Id" value="@Model.Id" />

                
                        <div class="col-md-12">
                            <div class="form-group row align-items-center">
                                <div class="col-md-12" style="padding-left: 0;">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="Price" name="Price" 
                                        style="height: 80px; font-size: 24px; text-align: center; line-height: 80px;"
                                        value="@(Model.Price > 0 ? (Model.Price == (int)Model.Price ? Model.Price.ToString("0").Replace('.', ',') : Model.Price.ToString("0.#####").Replace('.', ',')) : "" )"
                                        placeholder="@(Model.Price > 0 ? "" : "HenÃ¼z Belirlenmedi")" required  @(hasPermission ? "" : "disabled") />
                                 
                                        <div class="input-group-append">
                                            <select class="form-control" id="Currency" style=" height: 80px;" name="Currency"  @(hasPermission ? "" : "disabled")> >
                                                @if (Model.Currency == "EUR")
                                                {
                                                    <option value="EUR" selected>EUR</option>
                                                }
                                                else
                                                {
                                                    <option value="EUR">EUR</option>
                                                }
                                                @if (Model.Currency == "TRY")
                                                {
                                                    <option value="TRY" selected>TRY</option>
                                                }
                                                else
                                                {
                                                    <option value="TRY">TRY</option>
                                                }
                                                @if (Model.Currency == "USD")
                                                {
                                                    <option value="USD" selected>USD</option>
                                                }
                                                else
                                                {
                                                    <option value="USD">USD</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                     
<div class="col-md-12" style="padding-left: 0;">
    <button type="submit" class="btn btn-dark w-100" 
            @(hasPermission ? "" : "disabled")> 
        FiyatÄ± Kaydet <i class="fa-solid fa-handshake"></i>
    </button>
</div>
                    </form>
               
                </div>
       
                
                @if (Model.Customer != null)
                {
                    <div class="pdf-section">
                        <h5>MÃ¼ÅŸteri Bilgisi (@Model.CustomerId)</h5>
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <p><strong>Ad:</strong> @Model.Customer.Name</p>
                            <a href="@Url.Action("CustomerDetail","Customer", new { id = Model.CustomerId })" class="btn btn-outline-dark" style="display: inline-block;">
                                MÃ¼ÅŸteri SayfasÄ± <i class="fa-solid fa-shop"></i>
                            </a>
                        </div>
                        
                     
                        <p><strong>Ä°l:</strong> @(string.IsNullOrEmpty(Model.Customer.City) ? "BelirtilmemiÅŸ" : Model.Customer.City)</p>
                        <p><strong>MÃ¼ÅŸteri Sorumlusu: </strong> @Model.Customer.CreatedBy</p>
                        <p>
                            <strong>MÃ¼ÅŸteri Sorumlusu Mail: </strong> 
                            <span id="createdByEmail">@ViewData["CreatedByEmail"]</span>
                        </p>
                        
                        
                    
                        
                    </div>
                    
                }
                else
                {
                <div class="pdf-section">
                    <h5>MÃ¼ÅŸteri Bilgisi</h5>
                    <p><strong>MÃ¼ÅŸteri Bilgisi Mevcut DeÄŸil</strong></p>
                </div>
                }
            </div>
    
            <div class="col-md-6">
                <div class="pdf-section">
                    <h5>Teklif Bilgileri (@Model.Id)</h5>

                    <p><strong>Teklif AdÄ±:</strong> @Model.ProductName</p>
                    <p><strong>EnXBoy:</strong> <td>@(Convert.ToInt32(Model.Width).ToString("D3") + "X" + Convert.ToInt32(Model.Height).ToString("D3")+ "(AkÄ±ÅŸ)")</td>
                    </p>
                    <p><strong>KaÄŸÄ±t Bilgisi:</strong> @Model.PaperInfo?.Name</p>
                    <p><strong>Tutkal Bilgisi:</strong> @Model.AdhesiveInfo?.Name</p>

                    
                    
                    <p><strong>BaskÄ± Bilgisi:</strong> 
                        @if (Model.IsPrinted)
                        {
                            @:BaskÄ±lÄ±
                        }
                        else
                        {
                            @:BaskÄ±lÄ± DeÄŸil
                        }
                    </p>
                    
                    @if (Model.NumberOfColors > 0)
                    {
                        <p><strong>Renk SayÄ±sÄ±:</strong> @Model.NumberOfColors</p>
                    }
                    
                    <p><strong>Ek Ä°ÅŸlem:</strong> <span id="additionalProcessingName"></span></p>
                    <p>
                        <strong>Miktar:</strong> 
                        @(Model.OrderQuantity > 0 ? Model.OrderQuantity.ToString("#,##0").Replace(",", ".") : "HenÃ¼z girilmemiÅŸ") 
                        @Model.OrderMethod.Name
                    </p>
                    <p>
                 
                        <strong>AÃ§Ä±klama:</strong><span style="@(string.IsNullOrWhiteSpace(Model.Description) ? "" : "color: red;")"> @Model.Description</span>
                    </p>
                    

                </div>
    
                <div class="pdf-section">
                    <h5>Ã–deme ve Teslimat</h5>
                    <p><strong>Ã–deme Åžekli:</strong> @Model.PaymentMethod</p>
                    <p><strong>Vade:</strong> @(Model.PaymentTerm > 0 ? $"{Model.PaymentTerm} GÃ¼n" : "Belirtilmedi")</p>

                    <p><strong>Teslim Åžekli:</strong> @Model.DeliveryMethod?.Name</p>
                </div>
    
                @if (!string.IsNullOrEmpty(Model.OfferPicture))
                {
                <div class="pdf-section">
                    <h5>Teklif GÃ¶rseli</h5>
                    <img src="@Model.OfferPicture" alt="Offer Image" class="offer-image" />
                </div>
                }
            </div>
        </div>
    
        <div class="row g-4 mt-4">
            <div class="col-md-12">
                <div class="card h-100 shadow-sm">
                    <div class="card-header text-white" style="background-color: #1A1C2E;">
                        <h3 class="card-title m-0">
                            <i class="fa-solid fa-database"></i> LOG KayÄ±tlarÄ±
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="logTable">
                                <thead>
                                    <tr>
                                        <th>Tarih</th>
                                        <th>Alan</th>
                                        <th>Eski DeÄŸer</th>
                                        <th>Yeni DeÄŸer</th>
                                        <th>Ä°ÅŸlem TÃ¼rÃ¼</th>
                                        <th>DeÄŸiÅŸtiren</th>
                                    </tr>
                                </thead>
                                <tbody id="logTableBody">
                                    <!-- Log kayÄ±tlarÄ± buraya dinamik olarak eklenecek -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12 text-center">
                <button type="button" class="back-button btn btn-outline-primary" onclick="window.location.href='@Url.Action("ListOffer", "Customer")'">
                    <i class="fa fa-arrow-left" aria-hidden="true"></i> TeklÄ°f LÄ°stesÄ°ne GÄ°t
                    
                </button>
            </div>
        </div>
    </div>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        function getButtonClass(operationType) {
            switch (operationType) {
                case "OluÅŸturuldu":
                    return "btn-success";
                case "GÃ¼ncellendi":
                    return "btn-warning";
                case "Silindi":
                    return "btn-danger";
                case "Transfer Edildi":
                    return "btn-info";
                default:
                    return "btn-secondary";
            }
        }
          document.addEventListener("DOMContentLoaded", function () {
                // Form alanlarÄ±nÄ± seÃ§
                const widthInput = document.getElementById("width");
                const heightInput = document.getElementById("height");
                const paperInfoSelect = document.getElementById("paperInfo");
                const adhesiveInfoSelect = document.getElementById("adhesiveInfo");
                const productNameInput = document.getElementById("productName");
                const isPrintedSelect = document.getElementById("isPrinted");

                // ÃœrÃ¼n adÄ±nÄ± otomatik oluÅŸturma iÅŸlevi
                function updateProductName() {
                    // En ve boy deÄŸerlerini 3 basamaklÄ± formata dÃ¶nÃ¼ÅŸtÃ¼r
                    const widthValue = widthInput.value ? widthInput.value.padStart(3, '0') : "";
                    const heightValue = heightInput.value ? heightInput.value.padStart(3, '0') : "";

                    // KaÄŸÄ±t ve tutkal bilgisi iÃ§in seÃ§ilen deÄŸerleri al (Select2'dan seÃ§ilen deÄŸeri al)
                    const paperInfoValue = $(paperInfoSelect).find("option:selected").text() || "";
                    const adhesiveInfoValue = $(adhesiveInfoSelect).find("option:selected").text() || "";

                    // BaskÄ± durumu kontrolÃ¼ (SeÃ§ilen baskÄ± durumu)
                    const isPrintedValue = $(isPrintedSelect).find("option:selected").text();

                    // ÃœrÃ¼n adÄ±nÄ± oluÅŸtur
                    const productName = `${widthValue}X${heightValue} ${isPrintedValue} ${paperInfoValue} ${adhesiveInfoValue}`;

                    // ÃœrÃ¼n adÄ± alanÄ±na otomatik olarak yaz
                    productNameInput.value = productName;
                }

                // DeÄŸiÅŸiklik olduÄŸunda updateProductName fonksiyonunu Ã§aÄŸÄ±r
                widthInput.addEventListener("input", updateProductName);
                heightInput.addEventListener("input", updateProductName);
                $(paperInfoSelect).on("change", updateProductName);
                $(adhesiveInfoSelect).on("change", updateProductName);
                $(isPrintedSelect).on("change", updateProductName);

                // Sayfa yÃ¼klendiÄŸinde varsayÄ±lan deÄŸerlerle Ã¼rÃ¼n adÄ±nÄ± gÃ¼ncelle
                updateProductName();
            });
        $(document).ready(function() {
    // Controller'dan gelen AdditionalProcessing ID'leri
    var additionalProcessingIds = '@Model.AdditionalProcessing'; // Ã–rneÄŸin: "15, 16, 19"

    if (additionalProcessingIds) {
        // AJAX isteÄŸi ile ID'leri backend'e gÃ¶nderiyoruz
        $.ajax({
            url: '@Url.Action("GetAdditionalProcessingsByIds", "Customer")', // Backend'de yazdÄ±ÄŸÄ±mÄ±z metot
            type: 'GET',
            data: { ids: additionalProcessingIds }, // ID'leri gÃ¶nderiyoruz
            success: function(response) {
                if (response && response.length > 0) {
                    // DÃ¶nen isimleri birleÅŸtirip HTML'e yazÄ±yoruz
                    $('#additionalProcessingName').text(response.join(", "));
                } else {
                    $('#additionalProcessingName').text('Ek iÅŸlem bilgisi yok');
                }
            },
            error: function() {
                alert('Ek iÅŸlem bilgisi getirilemedi.');
            }
        });
    } else {
        // EÄŸer additionalProcessingIds boÅŸsa
        $('#additionalProcessingName').text('Ek iÅŸlem bilgisi yok');
    }
});

// loadChangeLogs iÅŸlevini global bir kapsamda tanÄ±mlÄ±yoruz
function loadChangeLogs() {
    console.log("loadChangeLogs iÅŸlevi Ã§aÄŸrÄ±ldÄ±."); // Ä°ÅŸlev Ã§aÄŸrÄ±sÄ±nÄ± kontrol edin
    const offerId = $('#offerId').val();

    $.ajax({
        url: '@Url.Action("GetChangeLogsByOfferId", "Customer")',
        type: 'GET',
        data: { offerId: offerId },
        success: function (logs) {
            console.log("Gelen log verileri:", logs); // Gelen loglarÄ± kontrol edin
            const tableBody = $('#logTableBody');
            tableBody.empty(); // Ã–nce tabloyu temizle

            if (logs && logs.length > 0) {
                logs.reverse().forEach(log => {
                    const row = `<tr>
                        <td>${log.date}</td>
                        <td>${log.field}</td>
                        <td>${log.oldValue}</td>
                        <td>${log.newValue}</td>
                       <td><button class="btn ${getButtonClass(log.operationType)}">${log.operationType}</button></td>
                        <td>${log.changedBy}</td>
                    </tr>`;
                    tableBody.append(row);
                });
            } else {
                const emptyRow = `<tr><td colspan="6" class="text-center">Log kaydÄ± bulunamadÄ±.</td></tr>`;
                tableBody.append(emptyRow);
            }
        },
        error: function () {
            alert('Log kayÄ±tlarÄ± yÃ¼klenemedi.');
        }
    });
}$('#updatePriceForm').on('submit', function (e) {
    e.preventDefault();

    let rawValue = $('#Price').val().replace(',', '.');
    $('#Price').val(rawValue); // DeÄŸeri geri koy

    let offerId = $('#offerId').val(); // Offer ID'yi alÄ±n
    if (!offerId) {
        console.error("OfferId bulunamadÄ±! Ä°ÅŸlem durduruldu.");
        return; // OfferId eksikse iÅŸlemi durdur
    }

    let formData = $(this).serialize(); // Form verilerini serialize et
    formData += `&Id=${offerId}`; // Id'yi formData'ya ekle

    // Fiyat gÃ¼ncelleme iÅŸlemi
    $.ajax({
        url: '@Url.Action("UpdatePrice", "Customer")',
        type: 'POST',
        data: formData,
        success: function (response) {
            console.log("UpdatePrice yanÄ±tÄ±: ", response);

            if (response.success) {
                // Fiyat baÅŸarÄ±yla gÃ¼ncellendi bildirimi
                Toastify({
                    text: "Fiyat baÅŸarÄ±yla gÃ¼ncellendi ðŸ¥³",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: { background: "#4CAF50" }
                }).showToast();

                // E-posta bildirimi gÃ¶nder
                sendEmail(offerId);
            } else {
                Toastify({
                    text: response.message || 'Fiyat gÃ¼ncellenirken bir hata oluÅŸtu.',
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: { background: "#FF0000" }
                }).showToast();
            }
        },
        error: function () {
            Toastify({
                text: 'Fiyat gÃ¼ncellenirken hata oluÅŸtu.',
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: "#FF0000" }
            }).showToast();
        }
    });

    function sendEmail(offerId) {
        sendEmailNotification(offerId).then(function (result) {
            if (result.success) {
                Toastify({
                    text: "Mail baÅŸarÄ±yla gÃ¶nderildi ðŸ“¨",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: { background: "#4CAF50" }
                }).showToast();

                // Tabloyu gÃ¼ncelle
                loadChangeLogs(); // Tabloyu yeniden yÃ¼kleyen iÅŸlevi Ã§aÄŸÄ±r
            } else {
                Toastify({
                    text: "E-posta gÃ¶nderilemedi. Tekrar denemek iÃ§in dokunun.",
                    duration: 8000,
                    gravity: "top",
                    position: "right",
                    style: { background: "#FF0000" },
                    onClick: function () {
                        sendEmail(offerId); // Tekrar dene
                    }
                }).showToast();
            }
        }).catch(function (error) {
            console.error("E-posta gÃ¶nderim hatasÄ±: ", error);

            Toastify({
                text: "E-posta gÃ¶nderim sÄ±rasÄ±nda bir hata oluÅŸtu. Tekrar denemek iÃ§in dokunun.",
                duration: 5000,
                gravity: "top",
                position: "right",
                style: { background: "#FF0000" },
                onClick: function () {
                    sendEmail(offerId); // Tekrar dene
                }
            }).showToast();
        });
    }
});


$(document).ready(function () {
    const offerId = $('#offerId').val();

    // Sayfa yÃ¼klendiÄŸinde loglarÄ± yÃ¼kle
    loadChangeLogs();

   
});

// Mail gÃ¶nderme fonksiyonu
function sendEmailNotification(offerId) {
    console.log("GÃ¶nderilen OfferId: ", offerId); // Konsolda kontrol

    return new Promise(function (resolve, reject) {
        $.ajax({
            url: '@Url.Action("SendPriceNotification", "Customer")',
            type: 'POST',
            data: { Id: offerId }, // DoÄŸru ID'yi gÃ¶nder
            success: function (response) {
                console.log("Backend yanÄ±tÄ±: ", response);
                resolve(response); // YanÄ±tÄ± geri dÃ¶ndÃ¼r
            },
            error: function (xhr) {
                let errorMessage = xhr.responseJSON ? xhr.responseJSON.message : 'Bilinmeyen hata';
                console.error("Hata: ", errorMessage);
                reject({ success: false, message: errorMessage });
            }
        });
    });
}


        document.getElementById('Price').addEventListener('input', function (e) {
    let value = e.target.value;

    // Sadece rakam ve virgÃ¼le izin ver
    value = value.replace(/[^0-9,.]/g, '');

    // EÄŸer karakter sayÄ±sÄ± 7'yi geÃ§erse, fazlasÄ±nÄ± sil
    if (value.length > 7) {
        value = value.substring(0, 7);
    }

    // NoktayÄ± virgÃ¼le Ã§evir
    value = value.replace('.', ',');

    // DeÄŸeri input alanÄ±na geri yaz
    e.target.value = value;
});



document.getElementById('Currency').addEventListener('change', function () {
    let price = parseFloat(document.getElementById('Price').value);
    let currency = this.value;

    
})


// Sayfa yenilendiÄŸinde localStorage'daki mesajÄ± kontrol et ve gÃ¶ster
$(document).ready(function () {
    const successMessage = localStorage.getItem('priceUpdateSuccess');
    if (successMessage) {
        Toastify({
            text: successMessage,
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "#4CAF50", // YeÅŸil renk
        }).showToast();
        // Mesaj gÃ¶sterildikten sonra localStorage'Ä± temizle
        localStorage.removeItem('priceUpdateSuccess');
    }
});
function convertPriceToWords(price, currency) {
    if (isNaN(price) || price === null || price === "") {
        return "Fiyat bilgisi yok";
    }

    let priceString = price.toString().replace('.', ','); // Nokta varsa virgÃ¼le Ã§evir
    let parts = priceString.split(','); // OndalÄ±k kÄ±smÄ± virgÃ¼lden ayÄ±r

    let wholePart = parts[0]; // Tam sayÄ± kÄ±smÄ±
    let fractionalPart = parts.length > 1 ? parts[1].padEnd(5, '0') : "00000"; // OndalÄ±k kÄ±smÄ± 5 basamak olacak ÅŸekilde tamamla

    if (currency === "TRY") {
        return wholePart + " TÃ¼rk LirasÄ± " + fractionalPart + " kuruÅŸ";
    } else if (currency === "USD") {
        return wholePart + " Dolar " + fractionalPart + " cent";
    } else if (currency === "EUR") {
        return wholePart + " Euro " + fractionalPart + " cent";
    }

    return wholePart + " " + currency + " " + fractionalPart;
}


        

    </script>
</body>

</html>